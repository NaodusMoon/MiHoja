<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Crear Hojas de Vida</title>
    <link rel="stylesheet" href="css/styles.css">
    
</head>
<body>

<!-- Navbar -->
<div class="navbar">
    <a class="logo"
       th:href="${#strings.isEmpty(filtrosQuery)} ? @{/consultar} : '/consultar?' + ${filtrosQuery}">
        [Logo]
    </a>

    <a class="app-name"
       th:href="${#strings.isEmpty(filtrosQuery)} ? @{/consultar} : '/consultar?' + ${filtrosQuery}">
        MiHoja
    </a>

    <div class="nav-links">
        <a th:href="${#strings.isEmpty(filtrosQuery)} ? @{/consultar} : '/consultar?' + ${filtrosQuery}"
           th:classappend="${paginaActual == 'consultar'} ? ' active'">
            Consultar
        </a>

        <a th:href="${#strings.isEmpty(filtrosQuery)} ? @{/insertar} : '/insertar?' + ${filtrosQuery}"
           th:classappend="${paginaActual == 'insertar'} ? ' active'">
            Insertar
        </a>
    </div>

    <button id="shutdownBtn" class="btn-apagar">Apagar App</button>
</div>











<!-- Mensajes desde controlador -->
<div th:if="${mensajeExito}" class="mensaje exito" th:text="${mensajeExito}"></div>
<div th:if="${mensajeError}" class="mensaje error" th:text="${mensajeError}"></div>

<!-- Botón flotante para subir archivo -->
<button type="button" class="archivo-btn" onclick="document.getElementById('archivo').click()">Insertar desde archivo</button>
<input type="file" id="archivo" name="archivo" accept=".xlsx" style="display:none" onchange="subirArchivo()">
<!-- Formulario SOLO para la imagen -->
<form id="form-imagen" method="post" enctype="multipart/form-data" style="margin-top: 80px;">
    <div style="text-align: center; margin-bottom: 30px;">
        <div style="width: 180px; height: 180px; margin: 0 auto; border: 2px dashed #aaa; border-radius: 10px; overflow: hidden;">
            <img id="previewImagen" src="" alt="Previsualización" style="width: 100%; height: 100%; object-fit: cover; display: none;">
        </div>
        <input type="file" id="imagen" name="imagen" accept="image/*" style="margin-top: 10px;">
        <!-- Campo oculto para guardar la URL de la imagen subida -->
        <input type="hidden" id="imagen_url" name="imagen_url">
    </div>
</form>

<!-- Formulario principal SOLO para datos -->
<form id="formulario-insercion" method="post" action="/api/insertar" style="margin-top: 40px;">
    <div class="form-container">

        <div class="form-group"><label for="nombres">Nombres</label><input type="text" id="nombres" name="nombres" required></div>
        <div class="form-group"><label for="apellidos">Apellidos</label><input type="text" id="apellidos" name="apellidos" required></div>
        <div class="form-group"><label for="cedula">Cedula</label><input type="text" id="cedula" name="cedula" required></div>
        <div class="form-group"><label for="lugarExpedicion">Lugar de Expedicion</label><input type="text" id="lugarExpedicion" name="lugarExpedicion"></div>
        <div class="form-group"><label for="fechaNacimiento">Fecha de Nacimiento</label><input type="date" id="fechaNacimiento" name="fechaNacimiento"></div>

        <div class="form-group">
            <label for="estado">Estado</label>
            <select id="estado" name="estado">
                <option value="activo">Activo</option>
                <option value="retirado">Retirado</option>
            </select>
        </div>

        <div class="form-group">
            <label for="numero_hijos">Número de Hijos</label>
            <input type="number" id="numero_hijos" name="numero_hijos" min="0">
        </div>

        <div class="form-group"><label for="formacionAcademica">Formacion Academica</label><input type="text" id="formacionAcademica" name="formacionAcademica"></div>
        <div class="form-group"><label for="codigo">Codigo</label><input type="text" id="codigo" name="codigo"></div>
        <div class="form-group"><label for="grado">Grado</label><input type="text" id="grado" name="grado"></div>
        <div class="form-group"><label for="cargo">Cargo</label><input type="text" id="cargo" name="cargo"></div>
        <div class="form-group"><label for="dependencia">Dependencia</label><input type="text" id="dependencia" name="dependencia"></div>
        <div class="form-group"><label for="enlaceSigep">Enlace Sigep</label><input type="text" id="enlaceSigep" name="enlaceSigep"></div>
        <div class="form-group"><label for="correoInstitucional">Correo</label><input type="email" id="correoInstitucional" name="correoInstitucional"></div>
        <div class="form-group"><label for="telefonoInstitucional">Telefono</label><input type="text" id="telefonoInstitucional" name="telefonoInstitucional"></div>
        <div class="form-group"><label for="direccion">Direccion</label><input type="text" id="direccion" name="direccion"></div>
        <div class="form-group"><label for="sexo">Sexo</label><input type="text" id="sexo" name="sexo"></div>
        <div class="form-group"><label for="titulo">Titulo</label><input type="text" id="titulo" name="titulo"></div>
        <div class="form-group"><label for="mesesExperiencia">Meses de Experiencia</label><input type="number" id="mesesExperiencia" name="mesesExperiencia"></div>
        <div class="form-group"><label for="medioTransporte">Medio de Transporte</label><input type="text" id="medioTransporte" name="medioTransporte"></div>
        <div class="form-group"><label for="procedencia">Procedencia del Trabajador</label><input type="text" id="procedencia" name="procedencia"></div>
        <div class="form-group"><label for="riesgo">Riesgo</label><input type="text" id="riesgo" name="riesgo"></div>
        <div class="form-group"><label for="examen">Examen de Ingreso</label><input type="text" id="examen" name="examen"></div>
        <div class="form-group"><label for="induccion">Induccion</label><input type="text" id="induccion" name="induccion"></div>
        <div class="form-group"><label for="fechaIngreso">Fecha de Ingreso</label><input type="date" id="fechaIngreso" name="fechaIngreso"></div>
        <div class="form-group"><label for="fechaEgreso">Fecha de Egreso</label><input type="date" id="fechaEgreso" name="fechaEgreso"></div>
        <div class="form-group"><label for="dotacion">Dotacion</label><input type="text" id="dotacion" name="dotacion"></div>
        <div class="form-group"><label for="arl">ARL</label><input type="text" id="arl" name="arl"></div>
        <div class="form-group"><label for="eps">EPS</label><input type="text" id="eps" name="eps"></div>
        <div class="form-group"><label for="afp">AFP</label><input type="text" id="afp" name="afp"></div>
        <div class="form-group"><label for="ccf">CCF</label><input type="text" id="ccf" name="ccf"></div>
        <div class="form-group"><label for="rh">RH</label><input type="text" id="rh" name="rh"></div>
        <div class="form-group">
            <label for="carnetVacunacion">Carnet de Vacunacion</label>
            <select id="carnetVacunacion" name="carnetVacunacion">
                <option value="true">Sí</option>
                <option value="false">No</option>
            </select>
        </div>
        <div class="form-group"><label for="enfermedades">Enfermedades</label><textarea id="enfermedades" name="enfermedades"></textarea></div>
        <div class="form-group"><label for="alergias">Alergias</label><textarea id="alergias" name="alergias"></textarea></div>
        <div class="form-group"><label for="medicamentos">Medicamentos</label><textarea id="medicamentos" name="medicamentos"></textarea></div>
        <div class="form-group"><label for="fechaFirmaContrato">Fecha de Firma de Contrato</label><input type="date" id="fechaFirmaContrato" name="fechaFirmaContrato"></div>
        <div class="form-group"><label for="nombreEmergencia">En caso de Emergencia llamar a:</label><input type="text" id="nombreEmergencia" name="nombreEmergencia"></div>
        <div class="form-group"><label for="parentesco">Parentesco</label><input type="text" id="parentesco" name="parentesco"></div>
        <div class="form-group"><label for="telefonoEmergencia">Numero telefonico del contacto</label><input type="text" id="telefonoEmergencia" name="telefonoEmergencia"></div>
        
        <!-- Campo oculto para incluir la URL de imagen subida -->
        <input type="hidden" id="imagen_url_datos" name="imagen_url">
    </div>

    <button type="submit" class="submit-btn">Insertar</button>
</form>


<!-- Mensaje flotante -->
<div id="mensaje" class="mensaje" style="display:none"></div>

<!-- 🔹 Mensaje de progreso -->
<div id="progreso" style="display:none;">
    <div class="spinner"></div>
    <span>Subiendo datos, por favor espere...</span>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const imagenInput = document.getElementById('imagen');
    const preview = document.getElementById('previewImagen');
    const progreso = document.getElementById('progreso');

    // Campo oculto para guardar la URL de la imagen
    const inputHidden = document.createElement('input');
    inputHidden.type = 'hidden';
    inputHidden.name = 'imagen_url';
    document.getElementById('formulario-insercion').appendChild(inputHidden);

    // Previsualizar y subir imagen al seleccionar
    imagenInput.addEventListener('change', async function (event) {
        const file = event.target.files[0];
        if (!file) {
            preview.src = '';
            preview.style.display = 'none';
            inputHidden.value = '';
            return;
        }

        // Previsualizar
        const reader = new FileReader();
        reader.onload = function (e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);

        // Mostrar progreso
        progreso.style.display = 'flex';

        // Subir al backend
        const formData = new FormData();
        formData.append('imagen', file);

        try {
            const resp = await fetch('/api/imagenes/subir', {
                method: 'POST',
                body: formData
            });

            if (!resp.ok) throw new Error('Error al subir imagen');

            const data = await resp.json();
            inputHidden.value = data.url; // /uploads/archivo.jpg
            mostrarToast('Imagen subida correctamente', true);
        } catch (err) {
            mostrarToast('Error al subir la imagen', false);
            console.error(err);
        } finally {
            progreso.style.display = 'none';
        }
    });

    // Enviar el formulario como application/x-www-form-urlencoded
    document.getElementById('formulario-insercion').addEventListener('submit', async function (e) {
        e.preventDefault();
        const form = e.target;
        const datos = Object.fromEntries(new FormData(form).entries());

        // Mostrar progreso
        progreso.style.display = 'flex';

        try {
            const resp = await fetch(form.action, {
                method: 'POST',
                body: new URLSearchParams(datos)
            });

            if (resp.ok) {
                mostrarToast('Datos enviados correctamente', true);
                form.reset();
                preview.style.display = 'none';
                inputHidden.value = '';
            } else {
                mostrarToast('Error al enviar datos', false);
            }
        } catch (err) {
            mostrarToast('Error de conexión', false);
            console.error(err);
        } finally {
            progreso.style.display = 'none';
        }
    });

    // 📌 Nuevo: Toast flotante
    function mostrarToast(texto, exito) {
        const toast = document.createElement('div');
        toast.className = 'toast ' + (exito ? 'success' : 'error');
        toast.textContent = texto;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }
});

// 📌 Función para subir archivo Excel con barra de progreso
async function subirArchivo() {
    const archivoInput = document.getElementById('archivo');
    const file = archivoInput.files[0];
    const progreso = document.getElementById('progreso'); // 👈 barra de progreso

    if (!file) {
        alert("Selecciona un archivo .xlsx");
        return;
    }

    const formData = new FormData();
    formData.append('file', file); // 👈 Debe coincidir con @RequestParam("file")

    // 📌 Mostrar barra de progreso
    progreso.style.display = 'flex';

    try {
        const resp = await fetch('/api/insertar/archivo', { // ✅ Endpoint correcto
            method: 'POST',
            body: formData
        });

        if (!resp.ok) throw new Error("Error al subir archivo");

        const data = await resp.text(); // 👈 Tu endpoint devuelve texto, no JSON
        mostrarToast("✅ " + data, true);
    } catch (err) {
        console.error(err);
        mostrarToast("❌ Error subiendo archivo", false);
    } finally {
        // 📌 Ocultar barra de progreso
        progreso.style.display = 'none';
    }
}
</script>










</body>
</html>
