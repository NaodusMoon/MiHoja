<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Editar Hoja de Vida</title>
  <link rel="stylesheet" href="/css/editar_persona.css">

  

  <!-- (Opcional) Soporte CSRF si usas Spring Security -->
  <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}">
</head>
<body>

<!-- ‚úÖ NAVBAR -->
<div class="navbar">
  <a class="logo" th:href="@{/consultar}">[Logo]</a>
  <a class="app-name" th:href="@{/consultar}">MiHoja</a>
  <div class="nav-links">
    <a th:href="@{/consultar}">Consultar</a>
    <a th:href="@{/insertar}">Insertar</a>
  </div>
  <button id="shutdownBtn" class="btn-apagar">Apagar App</button>
</div>

<!-- ‚úÖ ACCIONES SUPERIORES -->
<div class="acciones-superiores">
  <div>
    <a th:href="@{/consultar}">
      <button class="cerrar-btn">X</button>
    </a>
  </div>
<form th:action="@{/editar/{id}(id=${persona.id})}"
      th:object="${persona}"
      method="post"
      enctype="multipart/form-data"
      class="form-container">

  <!-- ‚ö° ID oculto -->
  <input type="hidden" th:field="*{id}" />

  <!-- üì∑ Imagen -->
  <div class="fila">
    <div class="dato full-width" style="text-align: center;">
      <div class="imagen-marco">
        <img id="previewImg" th:src="*{imagenUrl}" alt="Vista previa">
      </div>
      <br>
      <input type="file" id="imagenInput" name="imagen" accept="image/*">
      <input type="hidden" id="imagenUrl" name="imagenUrl" th:value="*{imagenUrl}">
    </div>
  </div>

  <!-- ‚úÖ Datos b√°sicos -->
  <div class="fila">
    <div class="dato"><label>N¬∞</label><input th:field="*{numero}" type="text"/></div>
    <div class="dato"><label>Nombres</label><input th:field="*{nombres}" type="text"/></div>
    <div class="dato"><label>Apellidos</label><input th:field="*{apellidos}" type="text"/></div>
  </div>

  <div class="fila">
    <div class="dato"><label>C√©dula</label><input th:field="*{cedula}" type="text"/></div>
    <div class="dato"><label>Lugar de Expedici√≥n</label><input th:field="*{lugarExpedicion}" type="text"/></div>
    <div class="dato"><label>Fecha de Nacimiento</label><input th:field="*{fechaNacimiento}" type="date"/></div>
  </div>

  <div class="fila">
    <div class="dato"><label>Direcci√≥n</label><input th:field="*{direccion}" type="text"/></div>
    <div class="dato"><label>Sexo</label><input th:field="*{sexo}" type="text"/></div>
    <div class="dato"><label>Correo Institucional</label><input th:field="*{correoInstitucional}" type="email"/></div>
  </div>

  <div class="fila">
    <div class="dato"><label>Tel√©fono</label><input th:field="*{telefonoInstitucional}" type="text"/></div>
    <div class="dato"><label>Estado</label><input th:field="*{estado}" type="text"/></div>
    <div class="dato"><label>N√∫mero de Hijos</label><input th:field="*{numeroHijos}" type="number"/></div>
  </div>

  <!-- ‚úÖ Formaci√≥n -->
  <div th:each="f, iterStat : *{formacion}">
    <div class="fila">
      <div class="dato"><label>Formaci√≥n Acad√©mica</label><input th:field="*{formacion[__${iterStat.index}__].formacionAcademica}" type="text"/></div>
      <div class="dato"><label>Grado</label><input th:field="*{formacion[__${iterStat.index}__].grado}" type="text"/></div>
      <div class="dato"><label>T√≠tulo</label><input th:field="*{formacion[__${iterStat.index}__].titulo}" type="text"/></div>
    </div>
  </div>
<!-- ‚úÖ Mostrar siempre al menos una fila -->
<div th:if="*{cargoLaboral != null}">
  <div th:each="c, iterStat : *{cargoLaboral}">
    <div class="fila">
      <div class="dato">
        <label>C√≥digo</label>
        <input type="text"
               th:field="*{cargoLaboral[__${iterStat.index}__].codigo}" />
      </div>
      <div class="dato">
        <label>Cargo</label>
        <input type="text"
               th:field="*{cargoLaboral[__${iterStat.index}__].cargo}" />
      </div>
      <div class="dato">
        <label>Dependencia</label>
        <input type="text"
               th:field="*{cargoLaboral[__${iterStat.index}__].dependencia}" />
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Si est√° vac√≠o, muestro una fila en blanco -->
<div th:if="*{cargoLaboral == null or #lists.isEmpty(cargoLaboral)}">
  <div class="fila">
    <div class="dato">
      <label>C√≥digo</label>
      <input type="text" name="cargoLaboral[0].codigo" />
    </div>
    <div class="dato">
      <label>Cargo</label>
      <input type="text" name="cargoLaboral[0].cargo" />
    </div>
    <div class="dato">
      <label>Dependencia</label>
      <input type="text" name="cargoLaboral[0].dependencia" />
    </div>
  </div>
</div>


<!-- ‚úÖ Datos personales laborales -->
<div th:each="pcl, iterStat : *{personaCargoLaboral}">
  <div class="fila">
    <div class="dato">
      <label>Meses Experiencia</label>
      <input type="number"
             th:field="*{personaCargoLaboral[__${iterStat.index}__].mesesExperiencia}" />
    </div>
    <div class="dato">
      <label>Fecha Ingreso</label>
      <input type="date"
             th:field="*{personaCargoLaboral[__${iterStat.index}__].fechaIngreso}" />
    </div>
    <div class="dato">
      <label>Fecha Firma Contrato</label>
      <input type="date"
             th:field="*{personaCargoLaboral[__${iterStat.index}__].fechaFirmaContrato}" />
    </div>
  </div>
</div>



  <!-- ‚úÖ Inducci√≥n y examen -->
  <div th:each="ind, iterStat : *{induccionExamen}">
    <div class="fila">
      <div class="dato"><label>Fecha de Egreso</label><input th:field="*{induccionExamen[__${iterStat.index}__].fechaEgreso}" type="date"/></div>
      <div class="dato"><label>Examen Ingreso</label><input th:field="*{induccionExamen[__${iterStat.index}__].examenIngreso}" type="checkbox"/></div>
      <div class="dato"><label>Inducci√≥n</label><input th:field="*{induccionExamen[__${iterStat.index}__].induccion}" type="checkbox"/></div>
    </div>
  </div>

  <!-- ‚úÖ Enlace SIGEP -->
  <div class="fila">
    <div class="dato full-width"><label>Enlace SIGEP</label><input th:field="*{enlaceSigep}" type="text"/></div>
  </div>

  <!-- ‚úÖ Salud -->
  <div class="fila">
    <div class="dato"><label>Dotaci√≥n</label><input th:field="*{salud.dotacion}" type="text"/></div>
    <div class="dato"><label>ARL</label><input th:field="*{salud.arl}" type="text"/></div>
    <div class="dato"><label>EPS</label><input th:field="*{salud.eps}" type="text"/></div>
  </div>
  <div class="fila">
    <div class="dato"><label>AFP</label><input th:field="*{salud.afp}" type="text"/></div>
    <div class="dato"><label>CCF</label><input th:field="*{salud.ccf}" type="text"/></div>
    <div class="dato"><label>RH</label><input th:field="*{salud.rh}" type="text"/></div>
  </div>
  <div class="fila">
    <div class="dato"><label>Carnet Vacunaci√≥n</label><input th:field="*{salud.carnetVacunacion}" type="checkbox"/></div>
    <div class="dato"></div>
    <div class="dato"></div>
  </div>

 <!-- Enfermedades -->
<div th:each="e, iterStat : *{enfermedad}">
  <div class="fila">
    <div class="dato full-width">
      <label>Enfermedad</label>
      <input th:field="*{enfermedad[__${iterStat.index}__].nombre}" type="text"/>
    </div>
  </div>
</div>

<!-- Alergias -->
<div th:each="a, iterStat : *{alergia}">
  <div class="fila">
    <div class="dato full-width">
      <label>Alergia</label>
      <input th:field="*{alergia[__${iterStat.index}__].nombre}" type="text"/>
    </div>
  </div>
</div>

<!-- Medicamentos -->
<div th:each="m, iterStat : *{medicamento}">
  <div class="fila">
    <div class="dato full-width">
      <label>Medicamento</label>
      <input th:field="*{medicamento[__${iterStat.index}__].nombre}" type="text"/>
    </div>
  </div>
</div>


  <!-- ‚úÖ Riesgo y procedencia -->
  <div th:each="rp, iterStat : *{riesgoProcedencia}">
    <div class="fila">
      <div class="dato"><label>Medio Transporte</label><input th:field="*{riesgoProcedencia[__${iterStat.index}__].medioTransporte}" type="text"/></div>
      <div class="dato"><label>Procedencia Trabajador</label><input th:field="*{riesgoProcedencia[__${iterStat.index}__].procedenciaTrabajador}" type="text"/></div>
      <div class="dato"><label>Riesgo</label><input th:field="*{riesgoProcedencia[__${iterStat.index}__].riesgo}" type="text"/></div>
    </div>
  </div>

  <!-- ‚úÖ Contacto emergencia -->
  <div th:each="ce, iterStat : *{contactoEmergencia}">
    <div class="fila">
      <div class="dato"><label>Nombre Contacto</label><input th:field="*{contactoEmergencia[__${iterStat.index}__].nombreContactoEmergencia}" type="text"/></div>
      <div class="dato"><label>Parentesco</label><input th:field="*{contactoEmergencia[__${iterStat.index}__].parentesco}" type="text"/></div>
      <div class="dato"><label>Tel√©fono</label><input th:field="*{contactoEmergencia[__${iterStat.index}__].telefonoContactoEmergencia}" type="text"/></div>
    </div>
  </div>

  <!-- ‚úÖ Bot√≥n -->
  <div class="fila">
    <div class="dato full-width" style="text-align:center;">
      <button type="submit" class="btn-guardar">Guardar</button>
    </div>
  </div>
</form>






<!-- ‚ö° Script: subir a /api/imagenes/subir con clave 'imagen' y guardar la URL -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const inputArchivo = document.getElementById("imagenInput");
    const preview = document.getElementById("previewImg");
    const hiddenUrl = document.getElementById("imagenUrl");

    if (!inputArchivo || !preview || !hiddenUrl) {
      console.warn("‚ö†Ô∏è No se encontraron elementos de imagen (imagenInput, previewImg, imagenUrl).");
      return;
    }

    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

    inputArchivo.addEventListener("change", async function () {
      if (!this.files || this.files.length === 0) return;

      const archivo = this.files[0];
      const formData = new FormData();
      formData.append("imagen", archivo); // üëà debe coincidir con @RequestParam("imagen")

      try {
        const headers = {};
        if (csrfToken && csrfHeader) {
          headers[csrfHeader] = csrfToken;
        }

        const resp = await fetch("/api/imagenes/subir", { // üëà usa tu endpoint real
          method: "POST",
          body: formData,
          headers
        });

        if (!resp.ok) {
          const txt = await resp.text();
          throw new Error("Respuesta no OK del servidor: " + txt);
        }

        const data = await resp.json(); // üëà el backend devuelve JSON
        if (!data.url) throw new Error("El backend no devolvi√≥ la URL de la imagen");

        // ‚úÖ Preview en la pantalla
        preview.src = data.url;
        preview.style.display = "block";

        // ‚úÖ Guardar en input hidden
        hiddenUrl.value = data.url;

        alert("Imagen subida con √©xito ‚úÖ");

      } catch (err) {
        console.error("‚ùå Error al subir imagen:", err);
        alert("Error al subir la imagen ‚ùå " + err.message);
      }
    });
  });
</script>



</body>
</html>
