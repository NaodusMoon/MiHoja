<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Editar Hoja de Vida</title>
  <link rel="stylesheet" href="/css/styles.css">

  <!-- (Opcional) Soporte CSRF si usas Spring Security -->
  <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}">
</head>
<body>

<!-- ‚úÖ NAVBAR -->
<div class="navbar">
  <a class="logo" th:href="@{/consultar}">[Logo]</a>
  <a class="app-name" th:href="@{/consultar}">MiHoja</a>
  <div class="nav-links">
    <a th:href="@{/consultar}">Consultar</a>
    <a th:href="@{/insertar}">Insertar</a>
  </div>
  <button id="shutdownBtn" class="btn-apagar">Apagar App</button>
</div>

<!-- ‚úÖ ACCIONES SUPERIORES -->
<div class="acciones-superiores">
  <div>
    <a th:href="@{/consultar}">
      <button class="cerrar-btn">X</button>
    </a>
  </div>
</div>

<!-- ‚úÖ FORMULARIO EDITAR -->
<div class="datos-container">
  <form th:action="@{/editar/{id}(id=${persona.id})}"
        th:object="${persona}"
        method="post">

    <!-- üì∑ Imagen -->
    <div class="fila fila--imagen">
      <div class="dato" style="text-align:center;">
        <div class="imagen-marco"
             style="display:inline-block; padding:10px; background:#fff; border:2px solid #ccc; border-radius:12px;">
          <img id="previewImg"
               th:src="${#strings.isEmpty(persona.imagen_url) ? '/img/placeholder.png' : persona.imagen_url}"
               alt="Foto"
               style="max-width:250px; height:auto; border-radius:10px;">
        </div>
        <br>
        <label>Seleccionar Imagen:</label>
        <input type="file" id="imagenInput" accept="image/*">
        <!-- campo oculto que se env√≠a al guardar la persona -->
        <input type="hidden" th:field="*{imagen_url}" id="imagen_url">
      </div>
    </div>

    <!-- üîπ Fila 1 -->
    <div class="fila">
      <div class="dato">
        <label>N¬∞</label>
        <input type="number" th:field="*{numero}">
      </div>
      <div class="dato">
        <label>Nombres</label>
        <input type="text" th:field="*{nombres}" required>
      </div>
      <div class="dato">
        <label>Apellidos</label>
        <input type="text" th:field="*{apellidos}" required>
      </div>
    </div>

    <!-- üîπ Fila 2 -->
    <div class="fila">
      <div class="dato">
        <label>C√©dula</label>
        <input type="text" th:field="*{cedula}" required>
      </div>
      <div class="dato">
        <label>Lugar de Expedici√≥n</label>
        <input type="text" th:field="*{lugar_expedicion}">
      </div>
      <div class="dato">
        <label>Fecha de Nacimiento</label>
        <input type="date" th:field="*{fecha_nacimiento}">
      </div>
    </div>

    <!-- üîπ Fila 3 -->
    <div class="fila">
      <div class="dato">
        <label>Direcci√≥n</label>
        <input type="text" th:field="*{direccion}">
      </div>
      <div class="dato">
        <label>Sexo</label>
        <select th:field="*{sexo}">
          <option value="">Seleccione</option>
          <option value="M">Masculino</option>
          <option value="F">Femenino</option>
        </select>
      </div>
      <div class="dato">
        <label>Correo Institucional</label>
        <input type="email" th:field="*{correo_institucional}">
      </div>
    </div>

    <!-- üîπ Fila 4 -->
    <div class="fila">
      <div class="dato">
        <label>Tel√©fono Institucional</label>
        <input type="text" th:field="*{telefono_institucional}">
      </div>
      <div class="dato">
        <label>Enlace SIGEP</label>
        <input type="text" th:field="*{enlace_sigep}">
      </div>
      <div class="dato">
        <label>Estado</label>
        <input type="text" th:field="*{estado}">
      </div>
    </div>

    <!-- ‚úÖ FORMACION -->
    <div class="fila">
      <div class="dato">
        <label>Formaci√≥n Acad√©mica</label>
        <textarea th:field="*{formacion}" placeholder="Ej: Bachiller, T√©cnico, Profesional"></textarea>
      </div>
    </div>

    <!-- ‚úÖ CARGO LABORAL -->
    <div class="fila">
      <div class="dato">
        <label>Cargos Laborales</label>
        <textarea th:field="*{cargo_laboral}" placeholder="Separar por coma"></textarea>
      </div>
    </div>

    <!-- ‚úÖ PCL -->
    <div class="fila">
      <div class="dato">
        <label>Contratos (PCL)</label>
        <textarea th:field="*{personaCargoLaboral}" placeholder="Separar por coma"></textarea>
      </div>
    </div>

    <!-- ‚úÖ INDUCCION/EXAMEN -->
    <div class="fila">
      <div class="dato">
        <label>Inducci√≥n / Ex√°menes</label>
        <textarea th:field="*{induccionExamen}" placeholder="Separar por coma"></textarea>
      </div>
    </div>

    <!-- ‚úÖ SALUD -->
    <div class="fila">
      <div class="dato"><label>Dotaci√≥n</label><input type="text" th:field="*{salud.dotacion}"></div>
      <div class="dato"><label>ARL</label><input type="text" th:field="*{salud.arl}"></div>
      <div class="dato"><label>EPS</label><input type="text" th:field="*{salud.eps}"></div>
    </div>

    <div class="fila">
      <div class="dato"><label>AFP</label><input type="text" th:field="*{salud.afp}"></div>
      <div class="dato"><label>CCF</label><input type="text" th:field="*{salud.ccf}"></div>
      <div class="dato"><label>RH</label><input type="text" th:field="*{salud.rh}"></div>
    </div>

    <div class="fila">
      <div class="dato">
        <label>Carnet Vacunaci√≥n</label>
        <select th:field="*{salud.carnetVacunacion}">
          <option value="true">S√≠</option>
          <option value="false">No</option>
        </select>
      </div>
    </div>

    <!-- ‚úÖ LISTAS -->
    <div class="fila">
      <div class="dato">
        <label>Enfermedades</label>
        <textarea th:field="*{enfermedad}" placeholder="Separar por coma"></textarea>
      </div>
      <div class="dato">
        <label>Alergias</label>
        <textarea th:field="*{alergia}" placeholder="Separar por coma"></textarea>
      </div>
      <div class="dato">
        <label>Medicamentos</label>
        <textarea th:field="*{medicamento}" placeholder="Separar por coma"></textarea>
      </div>
    </div>

    <!-- ‚úÖ RIESGO -->
    <div class="fila">
      <div class="dato">
        <label>Riesgos / Procedencia</label>
        <textarea th:field="*{riesgo_procedencia}" placeholder="Separar por coma"></textarea>
      </div>
    </div>

    <!-- ‚úÖ CONTACTO EMERGENCIA -->
    <div class="fila">
      <div class="dato">
        <label>Contactos de Emergencia</label>
        <textarea th:field="*{contacto_emergencia}" placeholder="Separar por coma"></textarea>
      </div>
    </div>

    <!-- üîπ Fila 5 -->
    <div class="fila">
      <div class="dato">
        <label>N√∫mero de Hijos</label>
        <input type="number" th:field="*{numero_hijos}">
      </div>
    </div>

    <!-- ‚úÖ BOT√ìN -->
    <div style="text-align:center; margin-top:20px;">
      <button type="submit" class="editar-btn">üíæ Guardar Cambios</button>
    </div>
  </form>
</div>

<!-- ‚ö° Script: subir a /api/imagenes/subir con clave 'imagen' y guardar la URL -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const inputArchivo = document.getElementById("imagenInput");
    const preview = document.getElementById("previewImg");
    const hiddenUrl = document.getElementById("imagen_url");

    if (!inputArchivo || !preview || !hiddenUrl) {
      console.warn("‚ö†Ô∏è No se encontraron elementos de imagen (imagenInput, previewImg, imagen_url).");
      return;
    }

    // ‚úÖ CSRF (si usas Spring Security)
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

    inputArchivo.addEventListener("change", async function () {
      if (!this.files || this.files.length === 0) return;

      const archivo = this.files[0];
      const formData = new FormData();
      formData.append("imagen", archivo);

      try {
        const headers = {};
        if (csrfToken && csrfHeader) {
          headers[csrfHeader] = csrfToken;
        }

        const resp = await fetch("/api/imagenes/subir", {
          method: "POST",
          body: formData,
          headers
        });

        if (!resp.ok) {
          const txt = await resp.text();
          throw new Error("Respuesta no OK del servidor: " + txt);
        }

        const data = await resp.json(); // { url: "/uploads/xxxx.png", ... }
        if (!data.url) {
          throw new Error("El servidor no devolvi√≥ 'url'.");
        }

        // ‚úÖ Preview en la pantalla
        preview.src = data.url;
        preview.style.display = "block";

        // ‚úÖ Guardar en input hidden
        hiddenUrl.value = data.url;

        alert("Imagen subida con √©xito ‚úÖ");

      } catch (err) {
        console.error("‚ùå Error al subir imagen:", err);
        alert("Error al subir la imagen ‚ùå " + err.message);
      }
    });
  });
</script>

</body>
</html>
